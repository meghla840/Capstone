<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Store Details — QuickAid</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>
<style>
:root{
  --brand:#49465b;
  --accent:#2563eb;
  --success:#16a34a;
  --danger:#dc2626;
  --muted:#6b7280;
  --light-bg:#f8f9fa;
}
body{
  margin:0;
  font-family: Inter, Arial, Helvetica, sans-serif;
  background:#eaf0f3;
  color:#0f172a;
}
.topbar{
  position:sticky; top:0; z-index:9999;
  background:var(--brand);
  color:white;
  padding:10px 16px;
  display:flex;
  align-items:center;
  justify-content:space-between;
}
.topbar h3{ margin:0; font-size:1.05rem; }
main{ max-width:920px; margin:22px auto; padding:0 16px 60px; }
.card{ background:#fff; border-radius:12px; padding:18px; box-shadow:0 4px 18px rgba(15,23,42,0.06); border:1px solid #e6eefc; }
.title-row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.title-left{ display:flex; align-items:center; gap:12px; }
.store-name{ font-size:20px; font-weight:700; margin:0; }
.city-pill{ padding:4px 8px; background:#f1f8f3; color:#065f46; border-radius:999px; font-size:12px; border:1px solid #d1f2dd; }
.rating-row{ display:flex; align-items:center; gap:8px; font-size:14px; color:var(--muted); }
.stars { color:#f59e0b; font-size:16px; letter-spacing:1px; cursor:pointer; }
.stock-badge{ padding:6px 10px; border-radius:8px; font-weight:600; font-size:13px; display:inline-block; }
.in-stock{ background:#d1fae5; color:#065f46; }
.out-stock{ background:#fee2e2; color:#991b1b; }
.info-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px 18px; margin-top:12px; align-items:center; }
.info-item{ font-size:14px; color:var(--muted); }
.info-item strong{ color:#0f172a; font-weight:600; }
.companies { margin-top:10px; }
.pill { display:inline-block; margin:4px 6px 4px 0; padding:6px 10px; background:#e8f5e9; border-radius:999px; font-size:12px; border:1px solid #c8e6c9; color:#0b5e2a; }
.btn-row{ display:flex; gap:10px; margin-top:16px; }
.btn{ flex:1; padding:10px 12px; border-radius:10px; border:none; cursor:pointer; display:inline-flex; align-items:center; justify-content:center; gap:8px; color:#fff; font-weight:600; }
.btn-call{ background:var(--accent); }
.btn-wh{ background:#25d366; }
.map-box{ margin-top:14px; height:280px; border-radius:10px; overflow:hidden; border:1px solid #dfe7f5; }

/* Professional review design */
.review-section{ margin-top:24px; }
.review-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
.review-list{ margin-top:12px; display:flex; flex-direction:column; gap:12px; }
.review-item{ background:#fff; border-radius:12px; padding:14px; box-shadow:0 3px 10px rgba(0,0,0,0.05); border:1px solid #e6eefc; display:flex; flex-direction:column; gap:8px; transition:transform .15s; }
.review-item:hover{ transform:translateY(-2px); }
.review-top{ display:flex; gap:12px; align-items:flex-start; }
.review-avatar{ width:40px; height:40px; border-radius:50%; object-fit:cover; }
.review-left{ flex:1; }
.review-meta{ color:var(--muted); font-size:13px; display:flex; gap:8px; align-items:center; }
.review-text{ font-size:14px; color:#0f172a; white-space:pre-wrap; }
.review-actions{ display:flex; gap:8px; align-items:center; color:var(--muted); }
.icon-btn{ background:transparent; border:none; cursor:pointer; padding:6px; border-radius:8px; transition:background .2s; }
.icon-btn:hover{ background:#f1f5f9; color:#111827; }
.reply-box{ background:var(--light-bg); padding:10px; border-radius:8px; border:1px solid #e6eefc; margin-top:8px; }
.reply-meta{ font-size:13px; color:var(--muted); margin-bottom:6px; display:flex; gap:8px; align-items:center; }
.reply-text{ font-size:14px; color:#065f46; }
.review-input{ margin-top:14px; background:#f8fafc; padding:12px; border-radius:10px; border:1px solid #e6eefc; display:flex; flex-direction:column; gap:8px; }
textarea{ width:100%; padding:10px; border-radius:8px; border:1px solid #d1d5db; font-size:14px; resize:vertical; min-height:80px; max-height:220px; }
.stars-input{ display:inline-flex; gap:6px; align-items:center; cursor:pointer; }
.stars-input .s{ font-size:20px; color:#cbd5e1; transition:transform .12s ease, color .12s ease; }
.stars-input .s.hovered, .stars-input .s.selected{ color:#f59e0b; transform:scale(1.07); }
.submit-btn{ padding:10px 12px; border-radius:8px; border:none; background:var(--accent); color:white; cursor:pointer; font-weight:700; }
.message-box{ margin-top:8px; font-size:13px; color:var(--danger); }
.see-more-btn{ margin-top:8px; width:100%; padding:10px; border-radius:8px; border:1px dashed #cbd5e1; background:white; cursor:pointer; }
.small-muted{ color:var(--muted); font-size:13px; }
.footer{ margin-top:28px; background:var(--brand); color:white; text-align:center; padding:14px 8px; border-radius:6px; }
@media (max-width:720px){ .info-grid{ grid-template-columns: 1fr; } .btn-row{ flex-direction:column; } }
</style>
</head>
<body>
<header class="topbar">
  <button onclick="history.back()" style="background:transparent; border:1px solid rgba(255,255,255,.12); color:white; padding:6px 10px; border-radius:8px; cursor:pointer;">
    <i class="bi bi-arrow-left"></i> Back
  </button>
  <h3>Store Details</h3>
  <div></div>
</header>
<main>
  <section class="card" id="cardRoot"></section>
  <footer class="footer">© 2025 QuickAid · All Rights Reserved</footer>
</main>

<script>
// =======================
// Current user (from profile.html)
// =======================
window.currentUser = window.currentUser || { name:"Guest", profileImg:"https://via.placeholder.com/40", role:"user" };

// =======================
// Store data
// =======================
const storeData = {
  "Green Road Pharmacy":{
    address:"Green Road, Dhaka",
    city:"Dhaka",
    contact:"+8801712345001",
    stock:["Square","Beximco","Incepta"],
    hours:"8:00 AM - 11:00 PM",
    openDays:"Everyday",
    pharmacyID:"PH-10234",
    inStock:true,
    rating:0,
  }
};

function storageKeyFor(storeName){ return "quickAid_store_reviews_" + encodeURIComponent(storeName); }
function loadReviews(storeName){ try{ const r=JSON.parse(localStorage.getItem(storageKeyFor(storeName))); return Array.isArray(r)?r:[]; }catch(e){return[];} }
function saveReviews(storeName,reviews){ localStorage.setItem(storageKeyFor(storeName), JSON.stringify(reviews)); }
function genId(){ return "r_"+Math.random().toString(36).slice(2,9); }
function getStoreName(){ const p=new URLSearchParams(window.location.search); return p.get("name")?decodeURIComponent(p.get("name")):"Green Road Pharmacy"; }
function computeAverage(reviews){ if(!reviews.length) return 0; const sum=reviews.reduce((s,r)=>s+(Number(r.stars)||0),0); return Math.round((sum/reviews.length)*10)/10; }
function timeAgo(ts){ const s=Math.floor((Date.now()-ts)/1000); if(s<60)return s+"s ago"; const m=Math.floor(s/60); if(m<60)return m+"m ago"; const h=Math.floor(m/60); if(h<24)return h+"h ago"; const d=Math.floor(h/24); return d+"d ago"; }
function escapeHtml(s){ if(!s&&s!==0) return ""; return String(s).replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
function renderStars(n){ return "★".repeat(n)+"☆".repeat(Math.max(0,5-n)); }

// =======================
// App state
// =======================
let visibleCount=4;
let currentStoreName=getStoreName();
let editingId=null;

// =======================
// Render
// =======================
function render(){
  const store=storeData[currentStoreName];
  if(!store){ document.getElementById("cardRoot").innerHTML="<p>Store not found.</p>"; return; }
  store.reviews = store.reviews || loadReviews(currentStoreName);
  store.rating = computeAverage(store.reviews);

  const companiesHTML = store.stock.map(c=>`<span class="pill">${escapeHtml(c)}</span>`).join("");
  const headerHtml = `
    <div class="title-row">
      <div class="title-left">
        <div>
          <p class="store-name">${escapeHtml(currentStoreName)}</p>
          <div class="rating-row">
            <div class="stars" id="storeStars">${renderStars(Math.round(store.rating))}</div>
            <div class="small-muted" id="storeRatingText">${store.rating} • ${store.reviews.length} reviews</div>
          </div>
        </div>
        <div style="margin-left:12px;">
          <div class="city-pill">${escapeHtml(store.city)}</div>
        </div>
      </div>
      <div style="text-align:right">
        <div class="stock-badge ${store.inStock ? "in-stock" : "out-stock"}">${store.inStock ? "✔ In Stock" : "✘ Out of Stock"}</div>
      </div>
    </div>
    <div class="info-grid">
      <div class="info-item"><strong>Address:</strong> ${escapeHtml(store.address)}</div>
      <div class="info-item"><strong>Contact:</strong> <a href="tel:${encodeURIComponent(store.contact)}">${escapeHtml(store.contact)}</a></div>
      <div class="info-item"><strong>Opening:</strong> ${escapeHtml(store.hours)}</div>
      <div class="info-item"><strong>Open Days:</strong> ${escapeHtml(store.openDays)}</div>
      <div class="info-item"><strong>Pharmacy ID:</strong> ${escapeHtml(store.pharmacyID)}</div>
    </div>
    <div class="companies">${companiesHTML}</div>
    <div class="btn-row">
      <button class="btn btn-call" onclick="window.location.href='tel:${encodeURIComponent(store.contact)}'"><i class="bi bi-telephone"></i> Call</button>
      <button class="btn btn-wh" onclick="openWhatsApp()"><i class="bi bi-whatsapp"></i> WhatsApp</button>
    </div>
    <div class="map-box" style="margin-top:12px;">
      <iframe src="https://www.google.com/maps?q=${encodeURIComponent(store.address)}&output=embed" width="100%" height="100%" frameborder="0" style="border:0;"></iframe>
    </div>
  `;
  document.getElementById("cardRoot").innerHTML = headerHtml + renderReviewsArea(store);
  attachStarsInputHandlers();
}

// =======================
// Reviews Area
// =======================
function renderReviewsArea(store){
  visibleCount=Math.min(visibleCount, Math.max(4, store.reviews.length));
  const sorted = [...store.reviews].sort((a,b)=>b.time-a.time).slice(0,visibleCount);

  const items = sorted.map(r=>{
    const isAuthor = r.name===window.currentUser.name;
    const replyHtml = r.reply ? `<div class="reply-box"><div class="reply-meta">Owner • ${timeAgo(r.reply.time)}</div><div class="reply-text">${escapeHtml(r.reply.text)}</div></div>` : "";
    return `
      <div class="review-item" data-id="${r.id}">
        <div class="review-top">
          <img src="${r.profileImg||'https://via.placeholder.com/40'}" class="review-avatar"/>
          <div class="review-left">
            <div class="review-meta">
              <div class="stars">${"★".repeat(r.stars)}${"☆".repeat(5-r.stars)}</div>
              <div class="small-muted"><strong>${escapeHtml(r.name)}</strong> • ${timeAgo(r.time)}</div>
            </div>
            <div class="review-text">${escapeHtml(r.text)}</div>
          </div>
          <div class="review-actions">
            ${isAuthor?`<button class="icon-btn" onclick="startEdit('${r.id}')"><i class="bi bi-pencil"></i></button>
            <button class="icon-btn" onclick="deleteReview('${r.id}')"><i class="bi bi-trash"></i></button>`:""}
          </div>
        </div>
        ${replyHtml}
        <div id="replyFormContainer_${r.id}"></div>
      </div>
    `;
  }).join("");

  const inputArea = `
    <div class="review-section">
      <div class="review-header">
        <div><strong>Customer Reviews</strong></div>
        <div class="small-muted">Showing ${Math.min(store.reviews.length,visibleCount)} of ${store.reviews.length}</div>
      </div>
      <div class="review-list">${items}</div>
      <div class="review-input">
        <div class="stars-input" id="starsInput">${[1,2,3,4,5].map(i=>`<span class="s" data-val="${i}">★</span>`).join("")}</div>
        <div class="small-muted" id="currentStarsText">5 stars</div>
        <textarea id="rText" placeholder="Write your review..."></textarea>
        <div class="message-box" id="reviewMsg"></div>
        <button class="submit-btn" onclick="submitReview()">Submit Review</button>
      </div>
    </div>
  `;
  return inputArea;
}

// =======================
// Stars input
// =======================
let selectedStars=5;
function attachStarsInputHandlers(){
  const stars = document.querySelectorAll("#starsInput .s");
  stars.forEach(s=>{
    s.addEventListener("mouseover", ()=>{ stars.forEach(x=>x.classList.remove("hovered")); for(let i=0;i<s.dataset.val;i++){ stars[i].classList.add("hovered"); } });
    s.addEventListener("mouseout", ()=>{ stars.forEach(x=>x.classList.remove("hovered")); updateStarsInputDisplay(); });
    s.addEventListener("click", ()=>{ selectedStars=Number(s.dataset.val); updateStarsInputDisplay(); });
  });
}
function updateStarsInputDisplay(){
  const stars = document.querySelectorAll("#starsInput .s");
  stars.forEach((s,i)=>{ s.classList.remove("selected"); if(i<selectedStars) s.classList.add("selected"); });
  document.getElementById("currentStarsText").innerText = selectedStars + " stars";
}

// =======================
// Submit review
// =======================
function submitReview(){
  const text = document.getElementById("rText").value.trim();
  const msgEl = document.getElementById("reviewMsg");
  msgEl.innerText="";
  if(!text){ msgEl.innerText="Review cannot be empty."; return; }

  const store=storeData[currentStoreName];
  const reviewerName = window.currentUser.name||"Guest";
  const profileImg = window.currentUser.profileImg||"https://via.placeholder.com/40";

  if(editingId){
    const idx = store.reviews.findIndex(r=>r.id===editingId);
    if(idx>=0 && store.reviews[idx].name===reviewerName){
      store.reviews[idx].text=text;
      store.reviews[idx].stars=selectedStars;
      store.reviews[idx].time=Date.now();
    }
    editingId=null;
  }else{
    store.reviews.push({ id:genId(), name:reviewerName, profileImg, text, stars:selectedStars, time:Date.now() });
  }

  saveReviews(currentStoreName, store.reviews);
  selectedStars=5; updateStarsInputDisplay();
  document.getElementById("rText").value="";
  render();
}

// =======================
// Edit/Delete
// =======================
function startEdit(id){
  const store=storeData[currentStoreName];
  const r=store.reviews.find(x=>x.id===id);
  if(!r || r.name!==window.currentUser.name) return;
  editingId=id;
  document.getElementById("rText").value=r.text;
  selectedStars=r.stars||5;
  updateStarsInputDisplay();
  document.getElementById("rText").focus();
}
function deleteReview(id){
  if(!confirm("Are you sure you want to delete this review?")) return;
  const store=storeData[currentStoreName];
  store.reviews = store.reviews.filter(r=>r.id!==id);
  saveReviews(currentStoreName, store.reviews);
  render();
}

// =======================
// WhatsApp
// =======================
function openWhatsApp(){
  const store=storeData[currentStoreName];
  const number = store.contact.replace(/\D/g,'');
  window.open(`https://wa.me/${number}`, "_blank");
}

// =======================
// Init
// =======================
render();
</script>
</body>
</html>
